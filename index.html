<script>
    // BACKEND URL
    const BACKEND_URL = 'https://ip-reputation-checker-j6iz.onrender.com';
    
    async function checkIP() {
        const ip = document.getElementById('ipInput').value.trim();
        const checkButton = document.getElementById('checkButton');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const error = document.getElementById('error');
        
        // Hide previous results
        result.style.display = 'none';
        error.style.display = 'none';
        
        // Validate IP format
        if (!isValidIP(ip)) {
            showError('Please enter a valid IP address (e.g., 8.8.8.8)');
            return;
        }
        
        // Show loading
        checkButton.disabled = true;
        loading.style.display = 'block';
        
        try {
            // Call backend API
            const response = await fetch(`${BACKEND_URL}/check?ip=${encodeURIComponent(ip)}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || data.message || 'API request failed');
            }
            
            // Convert backend response to frontend format
            const processedData = processBackendData(data);
            
            // Display results
            displayResults(processedData);
            
        } catch (err) {
            console.error('API Error:', err);
            showError(`Could not check IP: ${err.message}`);
        } finally {
            // Hide loading
            loading.style.display = 'none';
            checkButton.disabled = false;
        }
    }
    
    function processBackendData(data) {
        // Convert backend's "threat": "‚úÖ CLEAN" to "threatLevel": "clean"
        let threatLevel = 'clean';
        let emoji = '‚úÖ';
        
        if (data.threat && data.threat.includes('MALICIOUS')) {
            threatLevel = 'malicious';
            emoji = 'üö®';
        } else if (data.threat && data.threat.includes('SUSPICIOUS')) {
            threatLevel = 'suspicious';
            emoji = '‚ö†Ô∏è';
        }
        
        return {
            ip: data.ip,
            country: data.country || 'Unknown',
            isp: data.isp || 'Unknown',
            domain: data.domain || 'N/A',
            score: data.score || 0,
            reports: data.reports || 0,
            lastReported: data.lastReported || 'Never',
            threatLevel: threatLevel,
            emoji: emoji,
            status: data.status || 'success'
        };
    }
    
    function isValidIP(ip) {
        const ipRegex = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        return ipRegex.test(ip);
    }
    
    function displayResults(data) {
        const result = document.getElementById('result');
        
        // Set color based on threat level
        result.className = 'result ' + data.threatLevel;
        
        // Format the results
        result.innerHTML = `
            <div class="result-header">
                <span class="emoji">${data.emoji}</span>
                <h3>Results for ${data.ip || 'Unknown IP'}</h3>
            </div>
            
            <div class="details-grid">
                <div class="detail-item">
                    <div class="detail-label">Country</div>
                    <div class="detail-value">${data.country}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ISP / Organization</div>
                    <div class="detail-value">${data.isp}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Domain</div>
                    <div class="detail-value">${data.domain}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Threat Score</div>
                    <div class="detail-value">${data.score}%</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Total Reports</div>
                    <div class="detail-value">${data.reports}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Last Reported</div>
                    <div class="detail-value">${formatDate(data.lastReported)}</div>
                </div>
            </div>
            
            <div class="verdict">
                ${data.emoji} ${data.threatLevel.toUpperCase()} THREAT
                <div style="font-size: 1rem; margin-top: 10px; opacity: 0.9;">
                    ${getThreatDescription(data.threatLevel, data.score)}
                </div>
            </div>
        `;
        
        result.style.display = 'block';
    }
    
    function showError(message) {
        const error = document.getElementById('error');
        error.innerHTML = `<strong>Error:</strong> ${message}`;
        error.style.display = 'block';
    }
    
    function formatDate(dateString) {
        if (dateString === 'Never' || !dateString) return 'Never reported';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        } catch (e) {
            return dateString;
        }
    }
    
    function getThreatDescription(level, score) {
        if (level === 'malicious') {
            return `High confidence (${score}%) - Known malicious activity`;
        } else if (level === 'suspicious') {
            return `Medium confidence (${score}%) - Suspicious activity reported`;
        } else {
            return `Low confidence (${score}%) - Likely legitimate`;
        }
    }
    
    // Example IPs for quick testing
    document.addEventListener('DOMContentLoaded', function() {
        const examples = [
            '8.8.8.8',        // Google DNS (clean)
            '1.1.1.1',        // Cloudflare (clean)
            '185.220.101.34'  // Known malicious
        ];
        
        // Add example buttons
        const examplesHTML = examples.map(ip => 
            `<button onclick="document.getElementById('ipInput').value='${ip}'; checkIP();" 
                    style="margin: 5px; padding: 8px 15px; background: #eef; border: 1px solid #ccd; border-radius: 5px; cursor: pointer;">
             ${ip}
            </button>`
        ).join('');
        
        document.querySelector('.input-section').insertAdjacentHTML('afterend', 
            `<div style="margin: 15px 0; text-align: center; font-size: 0.9rem; color: #666;">
                Try: ${examplesHTML}
            </div>`
        );
    });
</script>
